<html>

<head>

 
<link rel="stylesheet" href="css/jquery.dragon-slider.css" type="text/css" />

<style>
body { margin:0px; padding:0px; overflow: hidden; background:black; }
.frame { position:relative; left:5%; top:30%; width:90%; height:60%; z-index:99; }
.dot { position:absolute; z-index:99; background:#CCC; width:35px; height:35px; border-radius: 100%; cursor: pointer; top:50%; left:50%; transform: translateX(-25%) translateY(-25%);}
.dot.faded { opacity:0.3; }
.tape { position: fixed; top:25px; right:25px; width:25px; height:25px; z-index:999; border:0px; }
box-icon { position:absolute; left:50%; top:50%; transform: translateX(-50%) translateY(-50%);}
#line { position:absolute; opacity:0.33; left:50%; width:2px; height:100%; margin-left:-1px; z-index:0; background:purple;}
#poster { position:absolute; z-index:-1; width:100%; height:100%; background-size:cover; opacity:0.66; background-image:url(img/puddle.jpg);}

#drawer { position:fixed; left:0px; top:0px; width:200px; height:100%; background:whitesmoke; z-index:999; transition:all 0.3s ease-in-out; transform: translateX(-100%); }
#drawer.open { transform: translateX(0%); }
#drawer-handle { position:absolute; z-index:999999; height:50px; width:50px; top:25px; right:-50px; background:white;  }

.sound-item { position:absolute; }

</style>



</head>

<body>


<div id="poster"></div>   

<div id="line"></div>

<div class='frame' id="arena"></div>


<div id="drawer">
    <div id="drawer-handle">
        <box-icon type='solid' name='tag-alt'></box-icon>
    </div>

    <div id="soundlist">
        <div class="sound-item" name="glory" file="theglory.mp3">The Glory</div>
    </div>

</div>


    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>

    <script src="js/jquery.dragon.js"></script>
    <script src="js/jquery.dragon-slider.js"></script>

    <script src="https://unpkg.com/boxicons@latest/dist/boxicons.js"></script>


<script src="https://pixijs.download/dev/pixi.min.js"></script>
<script src="js/pixi-sound.js"></script>




<script>

var socket = io();

var mytracks = [{'id':'farewell', 'file':'farewelltoafriend.mp3', "icon":"music" }];

$(document).ready(function(){
    
    Start();
    
});

function Start(){
    console.log("gathering...");
    var $data = {"this":"that"};
    socket.emit("gettracks", $data);
}

socket.on("catchtracks", function(data){
    console.log("generating sounds...");
    GenerateSounds(data);
});

$(document).on("dblclick", ".dot", function(){
    var target = $(this).attr("target");
    Sync(target);

});

$(document).on("click", "#drawer-handle", function(){
    $("#drawer").toggleClass("open");
});

function GenerateSounds(data){
    //console.log(data);
    $.each(data, function( index, item ) 
        {
        //console.log(item);
        $id = item.id;
        $filename = item.file;
        $it = item;
        
        //CHECK TO SEE IF ALREADY IN LOCAL ARRAY
        var $existing = SearchLocal($filename);

        console.log($existing);

        if ( $existing ) { console.log("already in place"); }
        else
            {
            console.log("adding sound:" + $id);
            GenerateDot("50", "50", $id, $filename);
            }


        
        });
    

}


function SearchLocal(filename){
    
    $switch = false;

    $.each(mytracks, function(index, item)
            {
            if (item.file === filename ) { $switch = true; }
            else { $switch = false }
            });
    
    return $switch;
}


function AddSound(sound, file){
    var $data = {"sound": sound, "file":file };
    socket.emit("addsound", $data);
}

socket.on("newsound", function(data){
    console.log("making sound: "+data.sound+" using file: "+data.file);
    PIXI.sound.add(data.sound, {
    url: 'audio/'+data.file,
    preload: true,
    loaded: function() {
        // duration can only be used once the sound is loaded
        //console.log('Duration: ', PIXI.sound.duration(sound), 'seconds');
        console.log(data.sound+' is loaded');
        StartVolume(data.sound);
        PIXI.sound.play(data.sound);
        }
    });
   
    MakeDraggable();

});






function StartVolume(target){
    var it = PIXI.sound._sounds[target];
    it.volume = 0.05;
}

function ChangeGain(target, gain){
    
    var $data = {"target": target, "gain":gain };
    socket.emit("volume", $data);

}

socket.on("changevolume", function(data){ 

    var it = PIXI.sound._sounds[data.target];
    if ( data.gain < 0 ) 
        { 
        data.gain = 0;
        $(".dot[target="+data.target+"]").addClass("faded");
        }
    else
        { 
        $(".dot[target="+data.target+"]").removeClass("faded");
        };

    console.log(data.gain);

    it.volume = data.gain;

});




function ChangePan(target, pan){
    var $data = {"target": target, "pan":pan };
    socket.emit("pan", $data);
    
}

socket.on("changepan", function(data){
    var it = PIXI.sound._sounds[data.target];
    it.filters = [ new PIXI.sound.filters.StereoFilter(data.pan) ];
    //console.log(it);
});


function Sync(target){
    var it = PIXI.sound._sounds[target];
    var currenttime = it.media.context.audioContext.currentTime;
    var $data = {"target": target, "current":currenttime };
    socket.emit("syncit", $data);
}

socket.on("sync", function(data){
    var it = PIXI.sound._sounds[data.target];
    PIXI.sound.stop(data.target);
    PIXI.sound.play(data.target);
    });


function MakeDraggable() {

    $('.draggable').dragon({  
          dragStart: function() 
            { 
            var Yposition = $(this).position().top;
			var Xposition = $(this).position().left;

            //console.log(Yposition+':'+Xposition);
            },
          drag: function() 
            {
			var Xposition = $(this).position().left - $('#arena').width() / 2;
			var Xpercent = ($('#arena').width() / 100).toFixed(0);
			
			var X = (Xposition / Xpercent).toFixed(0);
			var Xpan = (X / 100) * 2;
			//console.log(Xpan);

            var me = $(this).attr("target");

			ChangePan(me, Xpan);


			var Yposition = $('#arena').height() - $(this).position().top;
			var Ypercent = ($('#arena').height() / 100).toFixed(0);
			
			var Y = (Yposition / Ypercent).toFixed(0);
			var Ypan = (Y / 1000)*1;
			console.log(Ypan);
            ChangeGain(me,Ypan);
            }
         });

        }


$('.sound-item').dragon({  
          dragStart: function() 
            { 
            var Yposition = $(this).position().top;
			var Xposition = $(this).position().left;

            //console.log(Yposition+':'+Xposition);
            },
          drag: function() 
            {
			var Xposition = $(this).position().left - $('#arena').width() / 2;
			var Xpercent = ($('#arena').width() / 100).toFixed(0);
			
			var X = (Xposition / Xpercent).toFixed(0);
			var Xpan = (X / 100) * 2;
			//console.log(Xpan);

            var me = $(this).attr("target");


			var Yposition = $('#arena').height() - $(this).position().top;
			var Ypercent = ($('#arena').height() / 100).toFixed(0);
			
			var Y = (Yposition / Ypercent).toFixed(0);
			var Ypan = (Y / 1000)*1;
			//console.log(Ypan);
            },
            dragEnd: function()
            {
            var Yposition = $(this).position().top;
			var Xposition = $(this).position().left;
            var name = $(this).attr("name");
            var file = $(this).attr("file");
            GenerateDot(Xposition, Yposition, name, file);   
            }
         });


function GenerateDot(x, y, name, file){
    $data = {"x":x, "y":y, "name":name, "file":file};
    socket.emit("feeddot", $data);
}

socket.on("build", function(data){
    $new = {'id':data.name, 'file':data.file, "icon":"music" };
    mytracks.push($new);
    console.log(mytracks);
    var $element = "<div target='"+data.name+"' file='"+data.file+"' class='draggable dot'><box-icon stype='solid' name='shield'></box-icon></div>";
    $("#arena").append($element);
    AddSound(data.name, data.file);
});

</script>

</body>

</html>